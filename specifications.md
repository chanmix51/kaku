This project is a stash for thoughts based on the Zettelkasten method. 

The project is composed of a Backend service reachable through a HTTP API.

# Product description 

## Story Mapping

### Business language

`Stylo`
A Stylo interacts with notes, Thoughts and Questions. He creates Projects.
It belongs to an organization and is used by an organization (may be the same).
It signs the notes or thoughts it creates with a key composed of his own
identifier and the organizations identifiers.

`Piece of Information (PoI)`:
a Piece of Information is either a Note, a Thought or a Question. All PoI can
contain a short piece of textual information that can be accompanied by one or
several medias (images, sounds etc.) and can contain links.

`Note`:
A Note is a PoI that is imported from an external source. This may be notes
taken from a meeting or a book etc.

`Thought`:
A Thought is a PoI that can be seen as the digest of a Note or a previous
Thought or answer to a Question.

`Question`:
A Question is a way to open a new search field from previous information
(Thoughts or Notes). 

`Project`:
All pieces of information belong to a Project. Notes are often created in very
pragmatic context (reading of a book, work project etc.) whereas some projects
may become more theoretical (ie `life`) with Thoughts and Questions far more
general.

`Universe`
A Universe is a group of Projects that all belong to one or several Stylos.

`AuthenticationToken`
It belongs to an Organization. It represents a key to access the system and
handles authentication.

`Organization `
An Organization represents the legal owner of some AuthenticationToken and Stylos. 
It is the billable entity.

### Processes

A Stylo posts Notes in a Project. He can view all notes in a given Project. He
can then create Thoughts and Questions and discard Notes. A Thought can be
refuted by another Thought. 

### Taxonomy

There are several ways Pieces of Information (PoI) can be searched:
 * full text search
 * nested categories (not Notes)
 * tags (plain tags)
 * projects
 * references (books mostly)
 * links (find all PoI that link to a given PoI)

Each Thought or Question can relate to a parent Thought or Question and this creates trees of PoI.

There can be linked Thoughts or Questions (not Notes) on a PoI.

## Data Structures

### Note

 * imported_at Timestamp
 * stylo_id   StyloIdentifier
 * project_id  ProjectIdentifier
 * content     text

### Thought

 * thought_id           ThoughtIdentifier
 * parent_thought_id    Option(ThoughtIdentifier)
 * refuted_by           Option(ThoughtIdentifier)
 * created_at           timestamp
 * stylo_id             StyloIdentifier
 * project_id           ProjectIdentifier
 * variation            ThoughtVariation (Thought or Question)
 * content              text
 * tags                 text[]
 * categories           Category[]
 * media                Media[]
 * references           Reference[]
 * links                ThoughtIdentifier[]

### Project

 * project_id   ProjectIdentifier
 * universe_id  UniverseIdentifier
 * created_at   timestamp
 * name         text
 * locked       boolean
 * is_private   boolean

### Universe

 * universe_id      UniverseIdentifier
 * organization_id  OrganizationIdentifier

### Organization

 * organization_id  OrganizationIdentifier
 * name             text
 * certificate      json
 * public_key       text

An organization is a legally accountable entity. It owns a private key which is
used to sign pretty much everything that is done by the organization.

### AuthenticationToken

 * authentication_token_id  uuid
 * organization_id          OrganizationIdentifier
 * created_at               timestamp
 * valid_until              timestamp
 * identifier               text
 * token                    json

AuthenticationToken are generated by organizations to allow people or systems to
interact with the application in their name.

### Stylo

 * stylo_id                 StyloIdentifier
 * owner_organization_id    OrganizationIdentifier
 * actor_organization_id    OrganizationIdentifier
 * create_at                timestamp
 * display_name             text
 * is_locked                boolean
 * email                    text

 From a model perspective, a Stylo is a relation between 2 organizations (or
 one organization with itself). It grants an organization the right to edit notes
 on the behalf of an organization (may be the same). The owner organization may
 assign an email address to a stylo.

### StyloProjectAccess

 * stylo_id     StyloIdentifier
 * project_id   ProjectIdentifier
 * permissions  json

Project permission access.

## Value measurement 

Value can be measured by the work done on Notes. 

 * average notes input per day
 * average note lifetime

In the long term, the efficiency of the Search feature is the key of success:

 * average number of results per query
 * average number of queries per work session

## Commands

### Note creation

Command: CreateNoteCommand

Attributes:
- imported_at: timestamp
- stylo_id: uuid
- project_id: uuid
- content: text

Validation:
- Ensure `imported_at` is a valid timestamp.
- Ensure `stylo_id` is a valid integer and references an existing scribe.
- Ensure `project_id` is a valid integer and references an existing project.
- Ensure `content` is not empty.

Execution: Insert a new note in the notes book.

### Note discard

Command: ScratchNoteCommand

Attributes:
- note_id: integer

Validation:
- Ensure `note_id` is a valid integer and references an existing note.

Execution: Remove the note from the notes book.

## Queries

### Notes

Query: FetchNotesByProjectQuery

Parameters:
- project_id: integer

Execution:
- Select all records from the `note` table where `project_id` matches the provided parameter.

Query: FetchNoteByIdQuery

Parameters:
- note_id: integer

Execution:
- Select the record from the `note` table where `id` matches the provided parameter.

# Software architecture

3 API systems:
* OpenMind: that manages thoughts and scribes.
* Scrooge: that manages invoicing.
* SynApps: Event dispatcher for API systems.

## Services and Actors

### OpenMind application

services:
 * thoughts 
 * thought_search 
 * organization

actors:
 * api 
 * event dispatcher

### Scrooge application

services:
 * organization
 * invoice
 
 actors:
 * api
 * event_logger
 * time_keeper
 * accountant

## Database

Both applications use their own PostgreSQL database. The database uses the Trigram extension alongside the full text search with dedicated tables to denormalize data for fast search. The extension LTree is used to store categories.

# Hosting 

## Network

### Security

The API security will be handled by a [Biscuit](https://www.biscuitsec.org/). Each HTTP request will embed a token signed by the client which will be used to authenticate the scribe. 

## Logging